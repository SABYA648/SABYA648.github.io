import streamlit as st
import requests
from datetime import datetime

# Set page config (must be the very first Streamlit command)
st.set_page_config(
    page_title="Ultimate AI Parameter Tuner",
    page_icon=":rocket:",
    layout="wide",
    initial_sidebar_state="expanded"
)

GA_TRACKING_ID = "G-YBR866PTCR"  # Replace with your actual Google Analytics ID

GA_JS = f"""
<script async src="https://www.googletagmanager.com/gtag/js?id={GA_TRACKING_ID}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){{dataLayer.push(arguments);}}
  gtag('js', new Date());
  gtag('config', '{GA_TRACKING_ID}', {{'cookie_domain': 'auto'}});
</script>
"""

# Inject JavaScript for Google Analytics
st.markdown(GA_JS, unsafe_allow_html=True)

# Backend connection details
BACKEND_URL = "https://llm-tuner-backend.onrender.com/api/generate"
BACKEND_DOCS_URL = "https://github.com/SABYA648/LLM_TUNER_frontend/blob/main/readme.md"  # Replace with actual docs URL

def generate_response_backend(prompt, settings):
    payload = {
        "input": prompt,
        "settings": {
            "temperature": settings.get("Temperature", 0.7),
            "top_p": settings.get("Top P", 0.9),
            "max_tokens": settings.get("Max Tokens", 50),
            "frequency_penalty": settings.get("Frequency Penalty", 0.5),
            "presence_penalty": settings.get("Presence Penalty", 0.6),
            "repetition_penalty": settings.get("Repetition Penalty", 1.2),
            "beam_width": settings.get("Beam Width", 5),
            "temperature_decay": settings.get("Temperature Decay", 0.95),
            "top_k": settings.get("Top K", 40),
            "stop_sequence": settings.get("Stop Sequence", "."),
        }
    }
    try:
        response = requests.post(BACKEND_URL, json=payload)
        if response.status_code == 200:
            return response.json().get("response", "No response")
        return f"Backend Error: {response.json().get('error', 'Unknown error')}"
    except Exception as e:
        return f"Connection Error: {str(e)}"

# Extended preset options with 8 choices.
extended_preset_options = {
    "Custom": {},
    "Trusted Information": {
         "Temperature": 0.3,
         "Top P": 0.95,
         "Max Tokens": 100,
         "Repetition Penalty": 1.1,
         "Frequency Penalty": 0.3,
         "Presence Penalty": 0.2,
         "Beam Width": 3,
         "Temperature Decay": 0.98,
         "Top K": 20,
         "Stop Sequence": "."
    },
    "Creative Storytelling": {
         "Temperature": 0.9,
         "Top P": 0.8,
         "Max Tokens": 150,
         "Repetition Penalty": 1.0,
         "Frequency Penalty": 0.5,
         "Presence Penalty": 0.7,
         "Beam Width": 5,
         "Temperature Decay": 0.90,
         "Top K": 50,
         "Stop Sequence": "\n"
    },
    "Technical Explanation": {
         "Temperature": 0.5,
         "Top P": 0.9,
         "Max Tokens": 120,
         "Repetition Penalty": 1.2,
         "Frequency Penalty": 0.4,
         "Presence Penalty": 0.3,
         "Beam Width": 4,
         "Temperature Decay": 0.96,
         "Top K": 30,
         "Stop Sequence": "."
    },
    "Casual Conversation": {
         "Temperature": 0.7,
         "Top P": 0.85,
         "Max Tokens": 80,
         "Repetition Penalty": 1.0,
         "Frequency Penalty": 0.2,
         "Presence Penalty": 0.4,
         "Beam Width": 2,
         "Temperature Decay": 0.97,
         "Top K": 25,
         "Stop Sequence": "."
    },
    "Balanced": {
         "Temperature": 0.7,
         "Top P": 0.9,
         "Max Tokens": 100,
         "Repetition Penalty": 1.1,
         "Frequency Penalty": 0.3,
         "Presence Penalty": 0.4,
         "Beam Width": 3,
         "Temperature Decay": 0.95,
         "Top K": 30,
         "Stop Sequence": "."
    },
    "Innovative": {
         "Temperature": 0.85,
         "Top P": 0.8,
         "Max Tokens": 120,
         "Repetition Penalty": 1.0,
         "Frequency Penalty": 0.4,
         "Presence Penalty": 0.6,
         "Beam Width": 4,
         "Temperature Decay": 0.93,
         "Top K": 40,
         "Stop Sequence": "\n"
    },
    "Conservative": {
         "Temperature": 0.4,
         "Top P": 0.95,
         "Max Tokens": 80,
         "Repetition Penalty": 1.2,
         "Frequency Penalty": 0.2,
         "Presence Penalty": 0.3,
         "Beam Width": 2,
         "Temperature Decay": 0.97,
         "Top K": 20,
         "Stop Sequence": "."
    }
}

# Custom CSS for enhanced styling and mobile text justification.
st.markdown("""
    <style>
    .main {
        background-image: url("https://www.transparenttextures.com/patterns/diagmonds.png");
        background-attachment: fixed;
    }
    .stButton>button {
        background: linear-gradient(45deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        transition: all 0.3s;
    }
    .stButton>button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .param-card {
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .cv-floating {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    @media (max-width: 768px) {
        p {
            text-align: justify;
        }
    }
    </style>
    <a class="cv-floating" href="https://sabyasachimishra.dev" target="_blank">
        <img src="https://img.icons8.com/3d-fluency/100/resume.png" width="80">
    </a>
""", unsafe_allow_html=True)

# Sidebar with additional controls.
with st.sidebar:
    st.header("Advanced Controls")
    st.markdown(f"""
        ### Backend Connection
        **Endpoint:** `{BACKEND_URL}`  
        [View API Documentation]({BACKEND_DOCS_URL})
    """)
    
    if st.button("Clear History"):
        st.session_state.history = []
    
    st.markdown("---")
    st.markdown("""
    ### My Profile
    [![Portfolio](https://img.shields.io/badge/View-My%20Portfolio-%230077B5?style=for-the-badge)](https://sabyasachimishra.dev)
    [![LinkedIn](https://img.shields.io/badge/Connect-LinkedIn-%230077B5?style=for-the-badge)](https://www.linkedin.com/in/sabyasachimishra007/)
    """)

# Main Interface.
st.title("üöÄ Ultimate AI Parameter Tuner")
st.markdown("""
    *Harness the full power of AI customization with advanced parameter control. 
    Experiment with 10+ tuning parameters and see real-time results.*
""")

# Session state for response history.
if 'history' not in st.session_state:
    st.session_state.history = []

# Enhanced Preset Selector.
preset_choice = st.selectbox(
    "üö© Select Configuration Preset",
    list(extended_preset_options.keys()),
    help="Choose from professionally curated presets or use custom settings"
)

# Determine default parameter values based on extended preset selection.
preset_defaults = extended_preset_options.get(preset_choice, {})

# Parameter Grid with Tabs.
tab1, tab2, tab3 = st.tabs(["Core Parameters", "Advanced Controls", "Response Shaping"])

with tab1:
    col1, col2 = st.columns(2)
    with col1:
        params = {}
        params["Temperature"] = st.slider("üå°Ô∏è Temperature", 0.0, 2.0, 
            preset_defaults.get("Temperature", 0.7), 0.1)
        params["Max Tokens"] = st.number_input("üî¢ Max Tokens", 1, 2048, 
            preset_defaults.get("Max Tokens", 50))
    with col2:
        params["Top P"] = st.slider("üéØ Top P", 0.0, 1.0, 
            preset_defaults.get("Top P", 0.9), 0.01)
        params["Top K"] = st.number_input("üéØ Top K", 1, 100, 
            preset_defaults.get("Top K", 40))

with tab2:
    col1, col2 = st.columns(2)
    with col1:
        params["Beam Width"] = st.number_input("üì∂ Beam Width", 1, 10, 
            preset_defaults.get("Beam Width", 5))
        params["Temperature Decay"] = st.slider("üìâ Temp Decay", 0.5, 1.0, 
            preset_defaults.get("Temperature Decay", 0.95), 0.01)
    with col2:
        params["Stop Sequence"] = st.text_input("‚õî Stop Sequence", 
            preset_defaults.get("Stop Sequence", "."))
        params["Repetition Penalty"] = st.slider("üîÅ Repetition Penalty", 1.0, 2.0, 
            preset_defaults.get("Repetition Penalty", 1.2), 0.1)

with tab3:
    col1, col2 = st.columns(2)
    with col1:
        params["Frequency Penalty"] = st.slider("üìâ Frequency Penalty", 0.0, 1.0, 
            preset_defaults.get("Frequency Penalty", 0.5), 0.1)
    with col2:
        params["Presence Penalty"] = st.slider("üé≠ Presence Penalty", 0.0, 1.0, 
            preset_defaults.get("Presence Penalty", 0.6), 0.1)

# Enhanced Prompt Input.
prompt = st.text_area(
    "üìù Enter your prompt:", 
    "Explain quantum computing in simple terms...",
    height=150,
    help="Enter your custom instructions for the AI model"
)

# Generation Controls.
col1, col2, col3 = st.columns([2,1,2])
with col2:
    generate_btn = st.button("‚ú® Generate Response", use_container_width=True)

if generate_btn:
    if not prompt.strip():
        st.error("Please enter a valid prompt before generating")
    else:
        with st.spinner("üß† Crafting response..."):
            start_time = datetime.now()
            response = generate_response_backend(prompt, params)
            duration = (datetime.now() - start_time).total_seconds()
            
            st.session_state.history.append({
                "prompt": prompt,
                "response": response,
                "params": params.copy(),
                "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "response_time": f"{duration:.2f}s"
            })
            
            st.success(f"‚úÖ Response generated in {duration:.2f} seconds")
            st.markdown("### Generated Response")
            st.markdown(f"```\n{response}\n```")

# Response History.
if st.session_state.history:
    st.markdown("## üìú Response History")
    for idx, entry in enumerate(reversed(st.session_state.history)):
        with st.expander(f"Response #{len(st.session_state.history)-idx} - {entry['timestamp']}"):
            col1, col2 = st.columns([3,1])
            with col1:
                st.markdown(f"**Prompt:** {entry['prompt']}")
                st.markdown(f"**Response:**\n{entry['response']}")
            with col2:
                st.metric("Response Time", entry['response_time'])
                if st.button("‚Üª Reuse", key=f"reuse_{idx}"):
                    params.update(entry['params'])
                if st.button("‚¨áÔ∏è Download", key=f"dl_{idx}"):
                    st.download_button(
                        label="Download Response",
                        data=entry['response'],
                        file_name=f"ai_response_{idx}.txt",
                        mime="text/plain"
                    )